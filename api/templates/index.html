{% extends "base.html" %}
```
```html
{% block title %}Home - Anonymous Messaging{% endblock %}
```
```html
{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
{% endblock %}
```
```html
{% block content %}
    <div class="header">
        <h1>Anonymous Messaging System</h1>
        <div class="header-buttons">
            {% if session.permission_level == 1 %}
                <a href="{{ url_for('admin_dashboard') }}" class="admin-btn">Admin Dashboard</a>
            {% endif %}
            <button class="settings-btn" onclick="openSettings()">Settings</button>
            <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
        </div>
    </div>

    <!-- Settings Overlay -->
    <div id="settingsOverlay" class="settings-overlay">
        <div class="settings-modal">
            <div class="settings-header">
                <h2>Settings</h2>
                <button class="close-btn" onclick="closeSettings()">&times;</button>
            </div>
            <div class="settings-content">
                <!-- Theme Toggle -->
                <div class="setting-item">
                    <form method="POST" action="{{ url_for('toggle_theme') }}">
                        <button type="submit" class="theme-btn">
                            {% if session.theme == 1 %}
                                Switch to Light Mode
                            {% else %}
                                Switch to Dark Mode
                            {% endif %}
                        </button>
                    </form>
                </div>
                
                <!-- Password Reset -->
                <div class="setting-item">
                    <h3>Reset Password</h3>
                    <form method="POST" action="{{ url_for('settings_reset_password') }}" class="password-form">
                        <input type="password" name="current_password" placeholder="Current Password" required>
                        <input type="password" name="new_password" placeholder="New Password" required>
                        <input type="password" name="confirm_password" placeholder="Confirm New Password" required>
                        <button type="submit" class="reset-password-btn">Reset Password</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Display flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div>
                {% for category, message in messages %}
                    <div class="{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="form-container">
        <h2 class="welcome-message">Welcome, {{ session['username'] }}! Send a new message:</h2>
        <form method="POST">
            <textarea name="content" placeholder="Write your message here..." rows="4" required></textarea><br>
            <input type="submit" value="Send Message">
        </form>
    </div>

    <div class="messages-container">
        <h2>Messages:</h2>
        {% for message in messages %}
            <div class="message">
                <p>{{ message['content']|safe }}</p>  
            </div>
        {% endfor %}
    </div>
{% endblock %}
```
```html
{% block scripts %}
    <script>
        // Settings overlay functions
        function openSettings() {
            document.getElementById('settingsOverlay').style.display = 'flex';
        }
        
        function closeSettings() {
            document.getElementById('settingsOverlay').style.display = 'none';
        }
        
        // Close overlay when clicking outside the modal
        window.onclick = function(event) {
            const overlay = document.getElementById('settingsOverlay');
            if (event.target === overlay) {
                closeSettings();
            }
        }

        const messageContainer = document.querySelector('.messages-container');

        // Create a new EventSource to listen for new messages
        const eventSource = new EventSource('/stream');

        // When a new message is received, insert it at the top (consistent with descending order)
        eventSource.onmessage = function(event) {
            const newMessage = JSON.parse(event.data);
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.innerHTML = `<p>${newMessage.content}</p>`;

            // Find the h2 "Messages:" element and insert after it
            const messagesHeader = messageContainer.querySelector('h2');
            if (messagesHeader && messagesHeader.nextSibling) {
                messageContainer.insertBefore(messageDiv, messagesHeader.nextSibling);
            } else {
                messageContainer.appendChild(messageDiv);
            }
        };

        // Handle custom events from server
        eventSource.addEventListener('error', function(event) {
            if (event.data === 'unauthorized' || event.data === 'session_expired' || event.data === 'insufficient_permission') {
                console.log('Authentication/permission issue, redirecting to login');
                window.location.href = '/login';
            }
        });

        // Handle connection errors
        eventSource.onerror = function(event) {
            console.log("SSE connection error, but not logging out user");
            // Don't redirect on connection errors, just log them
        };
    </script>
{% endblock %}